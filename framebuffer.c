#include "framebuffer.h"
#ifndef __EMSCRIPTEN__
#include <SDL2/SDL.h>
#else
#include <SDL.h>
#endif

#define TILE_SIZE 8

static void _render_col(SDL_Renderer *renderer, int x, int y, int col);
static void _set_color(struct FrameBuffer *self, int c);
static unsigned char const _font[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  32 = ' ' */
	0x00, 0x00, 0x00, 0x5e, 0x00, 0x00, 0x00, 0x00, /*  33 = '!' */
	0x00, 0x00, 0x0e, 0x00, 0x00, 0x0e, 0x00, 0x00, /*  34 = '"' */
	0x00, 0x24, 0x7e, 0x24, 0x24, 0x7e, 0x24, 0x00, /*  35 = '#' */
	0x00, 0x44, 0x4a, 0xff, 0x4a, 0x32, 0x00, 0x00, /*  36 = '$' */
	0x00, 0x46, 0x26, 0x10, 0x08, 0x64, 0x62, 0x00, /*  37 = '%' */
	0x34, 0x4a, 0x4a, 0x42, 0x50, 0x30, 0x10, 0x00, /*  38 = '&' */
	0x00, 0x00, 0x00, 0x0e, 0x06, 0x00, 0x00, 0x00, /*  39 = ''' */
	0x00, 0x00, 0x00, 0x3c, 0x42, 0x00, 0x00, 0x00, /*  40 = '(' */
	0x00, 0x00, 0x00, 0x42, 0x3c, 0x00, 0x00, 0x00, /*  41 = ')' */
	0x00, 0x10, 0x54, 0x38, 0x38, 0x54, 0x10, 0x00, /*  42 = '*' */
	0x00, 0x10, 0x10, 0x7c, 0x10, 0x10, 0x00, 0x00, /*  43 = '+' */
	0x00, 0x00, 0x00, 0x80, 0x60, 0x00, 0x00, 0x00, /*  44 = ',' */
	0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, /*  45 = '-' */
	0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, /*  46 = '.' */
	0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, /*  47 = '/' */
	0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00, /*  48 = '0' */
	0x00, 0x00, 0x08, 0x04, 0x7e, 0x00, 0x00, 0x00, /*  49 = '1' */
	0x00, 0x44, 0x62, 0x52, 0x52, 0x52, 0x4c, 0x00, /*  50 = '2' */
	0x00, 0x40, 0x42, 0x42, 0x4a, 0x4a, 0x34, 0x00, /*  51 = '3' */
	0x00, 0x18, 0x26, 0x20, 0x20, 0x7e, 0x20, 0x00, /*  52 = '4' */
	0x00, 0x4e, 0x4a, 0x4a, 0x4a, 0x4a, 0x32, 0x00, /*  53 = '5' */
	0x00, 0x38, 0x64, 0x52, 0x52, 0x50, 0x20, 0x00, /*  54 = '6' */
	0x00, 0x02, 0x02, 0x12, 0x72, 0x1a, 0x06, 0x00, /*  55 = '7' */
	0x00, 0x34, 0x4a, 0x4a, 0x4a, 0x4a, 0x34, 0x00, /*  56 = '8' */
	0x00, 0x0c, 0x12, 0x12, 0x12, 0x02, 0x7c, 0x00, /*  57 = '9' */
	0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, /*  58 = ':' */
	0x00, 0x00, 0x00, 0x80, 0x48, 0x00, 0x00, 0x00, /*  59 = ';' */
	0x00, 0x00, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, /*  60 = '<' */
	0x00, 0x28, 0x28, 0x28, 0x28, 0x28, 0x28, 0x00, /*  61 = '=' */
	0x00, 0x00, 0x00, 0x44, 0x28, 0x10, 0x00, 0x00, /*  62 = '>' */
	0x00, 0x04, 0x02, 0x52, 0x12, 0x0c, 0x00, 0x00, /*  63 = '?' */
	0x7e, 0x81, 0xb9, 0xa5, 0xbd, 0xa1, 0x9e, 0x00, /*  64 = '@' */
	0x00, 0x78, 0x14, 0x12, 0x12, 0x14, 0x78, 0x00, /*  65 = 'A' */
	0x00, 0x7e, 0x42, 0x4a, 0x4a, 0x4c, 0x30, 0x00, /*  66 = 'B' */
	0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x24, 0x00, /*  67 = 'C' */
	0x00, 0x7e, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00, /*  68 = 'D' */
	0x00, 0x7e, 0x4a, 0x4a, 0x42, 0x42, 0x40, 0x00, /*  69 = 'E' */
	0x00, 0x7e, 0x12, 0x12, 0x02, 0x02, 0x02, 0x00, /*  70 = 'F' */
	0x00, 0x3c, 0x42, 0x42, 0x52, 0x52, 0x30, 0x00, /*  71 = 'G' */
	0x00, 0x7e, 0x08, 0x08, 0x08, 0x08, 0x7e, 0x00, /*  72 = 'H' */
	0x00, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00, 0x00, /*  73 = 'I' */
	0x00, 0x22, 0x42, 0x42, 0x42, 0x3e, 0x02, 0x00, /*  74 = 'J' */
	0x00, 0x7e, 0x10, 0x18, 0x26, 0x20, 0x40, 0x00, /*  75 = 'K' */
	0x00, 0x7e, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, /*  76 = 'L' */
	0x7e, 0x04, 0x08, 0x10, 0x08, 0x04, 0x7e, 0x00, /*  77 = 'M' */
	0x00, 0x7e, 0x04, 0x08, 0x10, 0x20, 0x7e, 0x00, /*  78 = 'N' */
	0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00, /*  79 = 'O' */
	0x00, 0x7e, 0x02, 0x12, 0x12, 0x12, 0x0c, 0x00, /*  80 = 'P' */
	0x00, 0x3c, 0x42, 0x42, 0x52, 0x22, 0x5c, 0x00, /*  81 = 'Q' */
	0x00, 0x7e, 0x02, 0x12, 0x32, 0x52, 0x4c, 0x00, /*  82 = 'R' */
	0x00, 0x44, 0x4a, 0x4a, 0x4a, 0x4a, 0x30, 0x00, /*  83 = 'S' */
	0x00, 0x02, 0x02, 0x7e, 0x02, 0x02, 0x00, 0x00, /*  84 = 'T' */
	0x00, 0x3e, 0x40, 0x40, 0x40, 0x40, 0x3e, 0x00, /*  85 = 'U' */
	0x00, 0x1e, 0x20, 0x40, 0x20, 0x1e, 0x00, 0x00, /*  86 = 'V' */
	0x3e, 0x40, 0x20, 0x10, 0x20, 0x40, 0x3e, 0x00, /*  87 = 'W' */
	0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00, 0x00, /*  88 = 'X' */
	0x00, 0x46, 0x48, 0x48, 0x48, 0x48, 0x3e, 0x00, /*  89 = 'Y' */
	0x00, 0x42, 0x62, 0x52, 0x4a, 0x46, 0x42, 0x00, /*  90 = 'Z' */
	0x00, 0x00, 0x00, 0x7e, 0x42, 0x42, 0x00, 0x00, /*  91 = '[' */
	0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00, /*  92 = '\' */
	0x00, 0x00, 0x42, 0x42, 0x7e, 0x00, 0x00, 0x00, /*  93 = ']' */
	0x00, 0x08, 0x04, 0x02, 0x04, 0x08, 0x00, 0x00, /*  94 = '^' */
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, /*  95 = '_' */
	0x00, 0x00, 0x00, 0x06, 0x0e, 0x00, 0x00, 0x00, /*  96 = '`' */
	0x00, 0x78, 0x14, 0x12, 0x12, 0x14, 0x78, 0x00, /*  97 = 'a' */
	0x00, 0x7e, 0x42, 0x4a, 0x4a, 0x4c, 0x30, 0x00, /*  98 = 'b' */
	0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x24, 0x00, /*  99 = 'c' */
	0x00, 0x7e, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00, /* 100 = 'd' */
	0x00, 0x7e, 0x4a, 0x4a, 0x42, 0x42, 0x40, 0x00, /* 101 = 'e' */
	0x00, 0x7e, 0x12, 0x12, 0x02, 0x02, 0x02, 0x00, /* 102 = 'f' */
	0x00, 0x3c, 0x42, 0x42, 0x52, 0x52, 0x30, 0x00, /* 103 = 'g' */
	0x00, 0x7e, 0x08, 0x08, 0x08, 0x08, 0x7e, 0x00, /* 104 = 'h' */
	0x00, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00, 0x00, /* 105 = 'i' */
	0x00, 0x22, 0x42, 0x42, 0x42, 0x3e, 0x02, 0x00, /* 106 = 'j' */
	0x00, 0x7e, 0x10, 0x18, 0x26, 0x20, 0x40, 0x00, /* 107 = 'k' */
	0x00, 0x7e, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, /* 108 = 'l' */
	0x7e, 0x04, 0x08, 0x10, 0x08, 0x04, 0x7e, 0x00, /* 109 = 'm' */
	0x00, 0x7e, 0x04, 0x08, 0x10, 0x20, 0x7e, 0x00, /* 110 = 'n' */
	0x00, 0x3c, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00, /* 111 = 'o' */
	0x00, 0x7e, 0x02, 0x12, 0x12, 0x12, 0x0c, 0x00, /* 112 = 'p' */
	0x00, 0x3c, 0x42, 0x42, 0x52, 0x22, 0x5c, 0x00, /* 113 = 'q' */
	0x00, 0x7e, 0x02, 0x12, 0x32, 0x52, 0x4c, 0x00, /* 114 = 'r' */
	0x00, 0x44, 0x4a, 0x4a, 0x4a, 0x4a, 0x30, 0x00, /* 115 = 's' */
	0x00, 0x02, 0x02, 0x7e, 0x02, 0x02, 0x00, 0x00, /* 116 = 't' */
	0x00, 0x3e, 0x40, 0x40, 0x40, 0x40, 0x3e, 0x00, /* 117 = 'u' */
	0x00, 0x1e, 0x20, 0x40, 0x20, 0x1e, 0x00, 0x00, /* 118 = 'v' */
	0x3e, 0x40, 0x20, 0x10, 0x20, 0x40, 0x3e, 0x00, /* 119 = 'w' */
	0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00, 0x00, /* 120 = 'x' */
	0x00, 0x46, 0x48, 0x48, 0x48, 0x48, 0x3e, 0x00, /* 121 = 'y' */
	0x00, 0x42, 0x62, 0x52, 0x4a, 0x46, 0x42, 0x00, /* 122 = 'z' */
	0x00, 0x00, 0x08, 0x7e, 0x42, 0x00, 0x00, 0x00, /* 123 = '{' */
	0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, /* 124 = '|' */
	0x00, 0x00, 0x42, 0x7e, 0x08, 0x00, 0x00, 0x00, /* 125 = '}' */
	0x10, 0x08, 0x08, 0x10, 0x20, 0x20, 0x10, 0x00, /* 126 = '~' */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 127 = ' ' */
};
static unsigned char const _red[] = {
	0xff, 0xff, 0xff, 0xff, 0xf2, 0xf3, 0xd3, 0xc3, 0xad, 0x84,
	0x79, 0x4a, 0xa9, 0x81, 0xc9, 0x9e, 0x7e, 0x5d, 0x23, 0x53,
};
static unsigned char const _green[] = {
	0xff, 0xd8, 0xb3, 0x5b, 0xaf, 0x9d, 0x8e, 0x72, 0x82, 0x55,
	0x4d, 0x37, 0x54, 0x4d, 0x2e, 0x20, 0x97, 0x76, 0x5a, 0x3a,
};
static unsigned char const _blue[] = {
	0xe1, 0xa9, 0x66, 0x4f, 0x92, 0x91, 0x84, 0x89, 0xcf, 0xa9,
	0x81, 0x78, 0x8a, 0x6e, 0x70, 0x81, 0x70, 0x68, 0x64, 0x44,
};

void
fb_init(struct FrameBuffer * restrict self, int w, int h,
        char const * restrict title)
{
	SDL_version linked;
	int allow_hidpi = 0;
	SDL_GetVersion(&linked);
	if (linked.major >= 2 && (linked.minor > 0 || linked.patch > 0))
	{
		allow_hidpi = SDL_WINDOW_ALLOW_HIGHDPI;
	}
	self->width = w;
	self->height = h;
	if (!title)
	{
		title = "GAME";
	}
	self->win = SDL_CreateWindow(title,
	                             SDL_WINDOWPOS_UNDEFINED,
	                             SDL_WINDOWPOS_UNDEFINED,
	                             3*w, 3*h,
	                             SDL_WINDOW_RESIZABLE
	                             | allow_hidpi
	                             );
	self->_renderer = SDL_CreateRenderer(self->win, -1,
	                                     SDL_RENDERER_ACCELERATED
	                                     | SDL_RENDERER_PRESENTVSYNC);
	SDL_SetWindowMinimumSize(self->win, w, h);
	SDL_RenderSetIntegerScale(self->_renderer, 1);
	SDL_RenderSetLogicalSize(self->_renderer, w, h);
}

void
fb_fill(struct FrameBuffer *self, int c)
{
	_set_color(self, c);
	SDL_RenderClear(self->_renderer);
}

void
fb_pixel(struct FrameBuffer *self, int x, int y, int c)
{
	_set_color(self, c);
	SDL_RenderDrawPoint(self->_renderer, x, y);
}

void
fb_line(struct FrameBuffer *self, int x1, int y1, int x2, int y2, int c)
{
	_set_color(self, c);
	SDL_RenderDrawLine(self->_renderer, x1, y1, x2, y2);
}

void
fb_hline(struct FrameBuffer *self, int x, int y, int w, int c)
{
	fb_line(self, x, y, x + w - 1, y, c);
}

void
fb_vline(struct FrameBuffer *self, int x, int y, int h, int c)
{
	fb_line(self, x, y, x, y + h - 1, c);
}

void
fb_fill_rect(struct FrameBuffer *self, int x, int y, int w, int h, int c)
{
	SDL_Rect r;
	_set_color(self, c);
	r.x = x;
	r.y = y;
	r.w = w;
	r.h = h;
	SDL_RenderFillRect(self->_renderer, &r);
}

void
fb_rect(struct FrameBuffer *self, int x, int y, int w, int h, int c)
{
	SDL_Rect r;
	_set_color(self, c);
	r.x = x;
	r.y = y;
	r.w = w;
	r.h = h;
	SDL_RenderDrawRect(self->_renderer, &r);
}

void
fb_text(struct FrameBuffer * restrict self, char const * restrict s,
        int x, int y, int c)
{
	int base, chr, i;
	_set_color(self, c);
	if (!s) { return; }
	while ((chr = *s))
	{
		if (chr < 32 || chr > 127) { continue; }
		base = (chr - 32) * 8;
		for (i = 0; i < 8; ++i)
		{
			_render_col(self->_renderer, x+i, y,
			            _font[base + i]);
		}
		x += 8;
		++s;
	}
}

void
fb_spr(struct FrameBuffer * restrict self, SDL_Texture * restrict tex,
       int n, int w, int h, int x, int y, int flippage)
{
	int texw;
	int npr;
	SDL_Rect source;
	SDL_Rect dest;
	SDL_RendererFlip flip =
		((flippage & FB_FLIP_VERT) ? SDL_FLIP_VERTICAL : 0)
		| ((flippage & FB_FLIP_HORZ) ? SDL_FLIP_HORIZONTAL : 0);
	SDL_QueryTexture(tex, NULL, NULL, &texw, NULL);
	npr = texw / TILE_SIZE;
	source.y = (n / npr) * TILE_SIZE;
	source.x = (n % npr) * TILE_SIZE;
	source.w = TILE_SIZE * w;
	source.h = TILE_SIZE * h;
	dest.x = x;
	dest.y = y;
	dest.w = source.w;
	dest.h = source.h;
	SDL_RenderCopyEx(self->_renderer, tex, &source, &dest, 0, NULL,
	                 flip);
}

void
fb_show(struct FrameBuffer *self)
{
	SDL_RenderPresent(self->_renderer);
}

static void
_set_color(struct FrameBuffer *self, int c)
{
	int r = 0;
	int g = 0;
	int b = 0;
	if (0 <= c && (unsigned int)(c) < sizeof(_red)/sizeof(_red[0]))
	{
		r = _red[c];
		g = _green[c];
		b = _blue[c];
	}
	SDL_SetRenderDrawColor(self->_renderer, r, g, b, 255);
}

static void
_render_col(SDL_Renderer *renderer, int x, int y, int col)
{
	int j = 0;
	while (col)
	{
		if (col & 1)
		{
			SDL_RenderDrawPoint(renderer, x, y + j);
		}
		++j;
		col >>= 1;
	}
}
